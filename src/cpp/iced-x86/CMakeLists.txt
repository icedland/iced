# SPDX-License-Identifier: MIT
# Copyright (C) 2018-present iced project and contributors
#
# This file was generated by GENERATOR

cmake_minimum_required( VERSION 3.25 )

project( iced_x86
  VERSION 1.0.0
  LANGUAGES CXX
  DESCRIPTION "x86/x64 disassembler library"
)

set( CMAKE_CXX_STANDARD 23 )
set( CMAKE_CXX_STANDARD_REQUIRED ON )
set( CMAKE_CXX_EXTENSIONS OFF )

# ============================================================================
# Feature Options (matching Rust Cargo.toml features)
# ============================================================================

# Core features (match Rust default features)
option( ICED_X86_DECODER "Enable decoder functionality" ON )
option( ICED_X86_ENCODER "Enable encoder functionality" ON )
option( ICED_X86_BLOCK_ENCODER "Enable block encoder functionality" ON )

# Information features
option( ICED_X86_OP_CODE_INFO "Enable opcode information functionality" ON )
option( ICED_X86_INSTR_INFO "Enable instruction information functionality" ON )

# Formatter features
option( ICED_X86_GAS "Enable gas formatter" ON )
option( ICED_X86_INTEL "Enable intel formatter" ON )
option( ICED_X86_MASM "Enable masm formatter" ON )
option( ICED_X86_NASM "Enable nasm formatter" ON )
option( ICED_X86_FAST_FMT "Enable fast formatter" ON )

# Instruction set exclusion features (like Rust's no_*)
option( ICED_X86_NO_VEX "Disable VEX instruction support" OFF )
option( ICED_X86_NO_EVEX "Disable EVEX instruction support" OFF )
option( ICED_X86_NO_XOP "Disable XOP instruction support" OFF )
option( ICED_X86_NO_D3NOW "Disable 3DNow instruction support" OFF )

# CPU architecture for code generation (not instruction decoding)
# Options: "native", "avx2", "avx", "sse4.2", "sse2", or empty for default
set( ICED_X86_ARCH "sse4.2" CACHE STRING "Target CPU architecture for optimizations (native, avx2, avx, sse4.2, sse2)" )

# Use constexpr handler tables (eliminates runtime deserialization)
# Note: constexpr handlers require additional work to fully support all handler types
option( ICED_X86_CONSTEXPR_HANDLERS "Use constexpr handler tables instead of runtime deserialization" OFF )

# ============================================================================
# Feature Validation
# ============================================================================

# Validate feature dependencies
if( ICED_X86_BLOCK_ENCODER AND NOT ICED_X86_ENCODER )
  message(FATAL_ERROR "ICED_X86_BLOCK_ENCODER requires ICED_X86_ENCODER to be enabled")
endif()

if( ICED_X86_ENCODER AND NOT ICED_X86_DECODER )
  message(FATAL_ERROR "ICED_X86_ENCODER requires ICED_X86_DECODER to be enabled (encoder uses decoder tables)")
endif()

# ============================================================================
# Source Files - Conditionally included based on features
# ============================================================================

# Core sources (always needed)
set( ICED_X86_CORE_SOURCES
  src/instruction.cpp
  src/tables.cpp
  src/register_info.cpp
  src/memory_size_info.cpp
  src/mvex_info_data.cpp
)

# Decoder sources
set( ICED_X86_DECODER_SOURCES
  src/decoder.cpp
  src/handlers.cpp
)

# Table deserializer is only needed when not using constexpr handlers
if( NOT ICED_X86_CONSTEXPR_HANDLERS )
  list( APPEND ICED_X86_DECODER_SOURCES src/table_deserializer.cpp )
endif()

# Encoder sources (includes instruction_create for programmatic instruction building)
set( ICED_X86_ENCODER_SOURCES
  src/instruction_create.cpp
  src/encoder.cpp
  src/encoder_handlers.cpp
  src/encoder_methods.cpp
  src/encoder_ops.cpp
)

# Block encoder sources
set( ICED_X86_BLOCK_ENCODER_SOURCES
  src/block_encoder.cpp
)

# Op code info sources
set( ICED_X86_OP_CODE_INFO_SOURCES
  src/op_code_info.cpp
)

# Instruction info sources
set( ICED_X86_INSTR_INFO_SOURCES
  src/instruction_info.cpp
)

# Build the source list based on enabled features
set( ICED_X86_SOURCES ${ICED_X86_CORE_SOURCES} )

if( ICED_X86_DECODER )
  list( APPEND ICED_X86_SOURCES ${ICED_X86_DECODER_SOURCES} )
endif()

if( ICED_X86_ENCODER )
  list( APPEND ICED_X86_SOURCES ${ICED_X86_ENCODER_SOURCES} )
endif()

if( ICED_X86_BLOCK_ENCODER )
  list( APPEND ICED_X86_SOURCES ${ICED_X86_BLOCK_ENCODER_SOURCES} )
endif()

if( ICED_X86_OP_CODE_INFO )
  list( APPEND ICED_X86_SOURCES ${ICED_X86_OP_CODE_INFO_SOURCES} )
endif()

if( ICED_X86_INSTR_INFO )
  list( APPEND ICED_X86_SOURCES ${ICED_X86_INSTR_INFO_SOURCES} )
endif()

# Library target
add_library( iced_x86 ${ICED_X86_SOURCES} )

target_include_directories( iced_x86
  PUBLIC
    $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>
    $<INSTALL_INTERFACE:include>
)

target_compile_features( iced_x86 PUBLIC cxx_std_23 )

# Enable warnings and aggressive optimizations
if( MSVC )
  target_compile_options( iced_x86 PRIVATE /W4 )
  # Aggressive optimizations for Release builds
  target_compile_options( iced_x86 PRIVATE
    $<$<CONFIG:Release>:/O2>
    $<$<CONFIG:Release>:/Ob3>
    $<$<CONFIG:Release>:/Oi>
    $<$<CONFIG:Release>:/Ot>
    $<$<CONFIG:Release>:/GT>
    $<$<CONFIG:Release>:/GL>
    $<$<CONFIG:Release>:/Gy>
    $<$<CONFIG:Release>:/EHsc>
  )
  # Architecture-specific optimizations for MSVC
  if( ICED_X86_ARCH STREQUAL "native" OR ICED_X86_ARCH STREQUAL "avx2" )
    target_compile_options( iced_x86 PRIVATE $<$<CONFIG:Release>:/arch:AVX2> )
  elseif( ICED_X86_ARCH STREQUAL "avx" )
    target_compile_options( iced_x86 PRIVATE $<$<CONFIG:Release>:/arch:AVX> )
  elseif( ICED_X86_ARCH STREQUAL "sse4.2" OR ICED_X86_ARCH STREQUAL "sse2" )
    # SSE2 is the default for x64, no flag needed (SSE4.2 has no specific MSVC flag)
  endif()
  # Link-time code generation for Release
  set_target_properties( iced_x86 PROPERTIES
    STATIC_LIBRARY_OPTIONS "$<$<CONFIG:Release>:/LTCG>"
  )
else()
  target_compile_options( iced_x86 PRIVATE -Wall -Wextra -Wpedantic )
  # Aggressive optimizations for Release builds (GCC/Clang)
  target_compile_options( iced_x86 PRIVATE
    $<$<CONFIG:Release>:-O3>
    $<$<CONFIG:Release>:-flto>
  )
  # Architecture-specific optimizations for GCC/Clang
  if( ICED_X86_ARCH STREQUAL "native" )
    target_compile_options( iced_x86 PRIVATE $<$<CONFIG:Release>:-march=native> )
  elseif( ICED_X86_ARCH STREQUAL "avx2" )
    target_compile_options( iced_x86 PRIVATE $<$<CONFIG:Release>:-march=haswell> )
  elseif( ICED_X86_ARCH STREQUAL "avx" )
    target_compile_options( iced_x86 PRIVATE $<$<CONFIG:Release>:-march=sandybridge> )
  elseif( ICED_X86_ARCH STREQUAL "sse4.2" )
    target_compile_options( iced_x86 PRIVATE $<$<CONFIG:Release>:-march=nehalem> )
  elseif( ICED_X86_ARCH STREQUAL "sse2" )
    target_compile_options( iced_x86 PRIVATE $<$<CONFIG:Release>:-march=x86-64> )
  endif()
endif()

# ============================================================================
# Feature-based Preprocessor Definitions
# ============================================================================

# Constexpr handlers flag
if( ICED_X86_CONSTEXPR_HANDLERS )
  target_compile_definitions( iced_x86 PUBLIC ICED_X86_CONSTEXPR_HANDLERS=1 )
endif()

# Core feature flags
if( NOT ICED_X86_DECODER )
  target_compile_definitions( iced_x86 PUBLIC ICED_X86_NO_DECODER )
endif()

if( NOT ICED_X86_ENCODER )
  target_compile_definitions( iced_x86 PUBLIC ICED_X86_NO_ENCODER )
endif()

if( NOT ICED_X86_BLOCK_ENCODER )
  target_compile_definitions( iced_x86 PUBLIC ICED_X86_NO_BLOCK_ENCODER )
endif()

# Information feature flags
if( NOT ICED_X86_OP_CODE_INFO )
  target_compile_definitions( iced_x86 PUBLIC ICED_X86_NO_OP_CODE_INFO )
endif()

if( NOT ICED_X86_INSTR_INFO )
  target_compile_definitions( iced_x86 PUBLIC ICED_X86_NO_INSTR_INFO )
endif()

# Formatter feature flags
if( NOT ICED_X86_GAS )
  target_compile_definitions( iced_x86 PUBLIC ICED_X86_NO_GAS )
endif()

if( NOT ICED_X86_INTEL )
  target_compile_definitions( iced_x86 PUBLIC ICED_X86_NO_INTEL )
endif()

if( NOT ICED_X86_MASM )
  target_compile_definitions( iced_x86 PUBLIC ICED_X86_NO_MASM )
endif()

if( NOT ICED_X86_NASM )
  target_compile_definitions( iced_x86 PUBLIC ICED_X86_NO_NASM )
endif()

if( NOT ICED_X86_FAST_FMT )
  target_compile_definitions( iced_x86 PUBLIC ICED_X86_NO_FAST_FMT )
endif()

# Instruction set exclusion flags
if( ICED_X86_NO_VEX )
  target_compile_definitions( iced_x86 PUBLIC ICED_X86_NO_VEX_INSTRUCTIONS )
endif()

if( ICED_X86_NO_EVEX )
  target_compile_definitions( iced_x86 PUBLIC ICED_X86_NO_EVEX_INSTRUCTIONS )
endif()

if( ICED_X86_NO_XOP )
  target_compile_definitions( iced_x86 PUBLIC ICED_X86_NO_XOP_INSTRUCTIONS )
endif()

if( ICED_X86_NO_D3NOW )
  target_compile_definitions( iced_x86 PUBLIC ICED_X86_NO_D3NOW_INSTRUCTIONS )
endif()

# Installation
include( GNUInstallDirs )

install( TARGETS iced_x86
  EXPORT iced_x86-targets
  LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}
  ARCHIVE DESTINATION ${CMAKE_INSTALL_LIBDIR}
)

install( DIRECTORY include/iced_x86
  DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}
)

install( EXPORT iced_x86-targets
  FILE iced_x86-targets.cmake
  NAMESPACE iced_x86::
  DESTINATION ${CMAKE_INSTALL_LIBDIR}/cmake/iced_x86
)

# ============================================================================
# Feature Summary
# ============================================================================

message( STATUS "iced-x86 C++ library configuration:" )
message( STATUS "  Decoder:       ${ICED_X86_DECODER}" )
message( STATUS "  Encoder:       ${ICED_X86_ENCODER}" )
message( STATUS "  Block Encoder: ${ICED_X86_BLOCK_ENCODER}" )
message( STATUS "  OpCode Info:   ${ICED_X86_OP_CODE_INFO}" )
message( STATUS "  Instr Info:    ${ICED_X86_INSTR_INFO}" )
message( STATUS "  GAS Formatter: ${ICED_X86_GAS}" )
message( STATUS "  Intel Fmt:     ${ICED_X86_INTEL}" )
message( STATUS "  MASM Fmt:      ${ICED_X86_MASM}" )
message( STATUS "  NASM Fmt:      ${ICED_X86_NASM}" )
message( STATUS "  Fast Fmt:      ${ICED_X86_FAST_FMT}" )
message( STATUS "  Target Arch:   ${ICED_X86_ARCH}" )

# Tests
option( ICED_X86_BUILD_TESTS "Build unit tests" ON )

if( ICED_X86_BUILD_TESTS )
  enable_testing()
  add_subdirectory( tests )
endif()
