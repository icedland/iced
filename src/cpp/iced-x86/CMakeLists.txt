# SPDX-License-Identifier: MIT
# Copyright (C) 2018-present iced project and contributors
#
# This file was generated by GENERATOR

cmake_minimum_required( VERSION 3.25 )

project( iced_x86
  VERSION 1.0.0
  LANGUAGES CXX
  DESCRIPTION "x86/x64 disassembler library"
)

set( CMAKE_CXX_STANDARD 23 )
set( CMAKE_CXX_STANDARD_REQUIRED ON )
set( CMAKE_CXX_EXTENSIONS OFF )

# Library target
add_library( iced_x86
  src/instruction.cpp
  src/instruction_create.cpp
  src/tables.cpp
  src/decoder.cpp
  src/handlers.cpp
  src/table_deserializer.cpp
  src/encoder.cpp
  src/encoder_handlers.cpp
  src/encoder_methods.cpp
  src/encoder_ops.cpp
  src/mvex_info_data.cpp
  src/register_info.cpp
  src/op_code_info.cpp
  src/block_encoder.cpp
  src/instruction_info.cpp
  src/memory_size_info.cpp
)

target_include_directories( iced_x86
  PUBLIC
    $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>
    $<INSTALL_INTERFACE:include>
)

target_compile_features( iced_x86 PUBLIC cxx_std_23 )

# Enable warnings and aggressive optimizations
if( MSVC )
  target_compile_options( iced_x86 PRIVATE /W4 )
  # Aggressive optimizations for Release builds
  target_compile_options( iced_x86 PRIVATE
    $<$<CONFIG:Release>:/O2>           # Maximum optimization
    $<$<CONFIG:Release>:/Ob3>          # Aggressive inlining
    $<$<CONFIG:Release>:/Oi>           # Enable intrinsic functions
    $<$<CONFIG:Release>:/Ot>           # Favor fast code
    $<$<CONFIG:Release>:/GT>           # Fiber-safe optimizations
    $<$<CONFIG:Release>:/GL>           # Whole program optimization
    $<$<CONFIG:Release>:/Gy>           # Function-level linking
    $<$<CONFIG:Release>:/arch:AVX2>    # Use AVX2 instructions
  )
  # Link-time code generation for Release
  set_target_properties( iced_x86 PROPERTIES
    STATIC_LIBRARY_OPTIONS "$<$<CONFIG:Release>:/LTCG>"
  )
else()
  target_compile_options( iced_x86 PRIVATE -Wall -Wextra -Wpedantic )
  # Aggressive optimizations for Release builds (GCC/Clang)
  target_compile_options( iced_x86 PRIVATE
    $<$<CONFIG:Release>:-O3>
    $<$<CONFIG:Release>:-march=native>
    $<$<CONFIG:Release>:-flto>
    $<$<CONFIG:Release>:-fno-exceptions>
  )
endif()

# Installation
include( GNUInstallDirs )

install( TARGETS iced_x86
  EXPORT iced_x86-targets
  LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}
  ARCHIVE DESTINATION ${CMAKE_INSTALL_LIBDIR}
)

install( DIRECTORY include/iced_x86
  DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}
)

install( EXPORT iced_x86-targets
  FILE iced_x86-targets.cmake
  NAMESPACE iced_x86::
  DESTINATION ${CMAKE_INSTALL_LIBDIR}/cmake/iced_x86
)

# Tests
option( ICED_X86_BUILD_TESTS "Build unit tests" ON )

if( ICED_X86_BUILD_TESTS )
  enable_testing()
  add_subdirectory( tests )
endif()
