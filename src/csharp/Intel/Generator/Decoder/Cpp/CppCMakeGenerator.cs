// SPDX-License-Identifier: MIT
// Copyright (C) 2018-present iced project and contributors

using System.IO;
using Generator.IO;

namespace Generator.Decoder.Cpp {
	[Generator( TargetLanguage.Cpp, 99 )]
	sealed class CppCMakeGenerator {
		readonly GenTypes genTypes;

		public CppCMakeGenerator( GeneratorContext generatorContext ) {
			genTypes = generatorContext.Types;
		}

		public void Generate() {
			GenerateCMakeLists();
			GenerateMainHeader();
			GenerateTestsCMakeLists();
		}

		void GenerateCMakeLists() {
			var filename = CppConstants.GetFilename( genTypes, "CMakeLists.txt" );
			var dir = Path.GetDirectoryName( filename );
			if ( !string.IsNullOrEmpty( dir ) && !Directory.Exists( dir ) )
				Directory.CreateDirectory( dir );

			using var writer = new StreamWriter( filename );

			writer.WriteLine( "# SPDX-License-Identifier: MIT" );
			writer.WriteLine( "# Copyright (C) 2018-present iced project and contributors" );
			writer.WriteLine( "#" );
			writer.WriteLine( "# This file was generated by GENERATOR" );
			writer.WriteLine();
			writer.WriteLine( "cmake_minimum_required( VERSION 3.25 )" );
			writer.WriteLine();
			writer.WriteLine( "project( iced_x86" );
			writer.WriteLine( "  VERSION 1.0.0" );
			writer.WriteLine( "  LANGUAGES CXX" );
			writer.WriteLine( "  DESCRIPTION \"x86/x64 disassembler library\"" );
			writer.WriteLine( ")" );
			writer.WriteLine();
			writer.WriteLine( "set( CMAKE_CXX_STANDARD 23 )" );
			writer.WriteLine( "set( CMAKE_CXX_STANDARD_REQUIRED ON )" );
			writer.WriteLine( "set( CMAKE_CXX_EXTENSIONS OFF )" );
			writer.WriteLine();

			// Feature Options section
			writer.WriteLine( "# ============================================================================" );
			writer.WriteLine( "# Feature Options (matching Rust Cargo.toml features)" );
			writer.WriteLine( "# ============================================================================" );
			writer.WriteLine();
			writer.WriteLine( "# Core features (match Rust default features)" );
			writer.WriteLine( "option( ICED_X86_DECODER \"Enable decoder functionality\" ON )" );
			writer.WriteLine( "option( ICED_X86_ENCODER \"Enable encoder functionality\" ON )" );
			writer.WriteLine( "option( ICED_X86_BLOCK_ENCODER \"Enable block encoder functionality\" ON )" );
			writer.WriteLine();
			writer.WriteLine( "# Information features" );
			writer.WriteLine( "option( ICED_X86_OP_CODE_INFO \"Enable opcode information functionality\" ON )" );
			writer.WriteLine( "option( ICED_X86_INSTR_INFO \"Enable instruction information functionality\" ON )" );
			writer.WriteLine();
			writer.WriteLine( "# Formatter features" );
			writer.WriteLine( "option( ICED_X86_GAS \"Enable gas formatter\" ON )" );
			writer.WriteLine( "option( ICED_X86_INTEL \"Enable intel formatter\" ON )" );
			writer.WriteLine( "option( ICED_X86_MASM \"Enable masm formatter\" ON )" );
			writer.WriteLine( "option( ICED_X86_NASM \"Enable nasm formatter\" ON )" );
			writer.WriteLine( "option( ICED_X86_FAST_FMT \"Enable fast formatter\" ON )" );
			writer.WriteLine();
			writer.WriteLine( "# Instruction set exclusion features (like Rust's no_*)" );
			writer.WriteLine( "option( ICED_X86_NO_VEX \"Disable VEX instruction support\" OFF )" );
			writer.WriteLine( "option( ICED_X86_NO_EVEX \"Disable EVEX instruction support\" OFF )" );
			writer.WriteLine( "option( ICED_X86_NO_XOP \"Disable XOP instruction support\" OFF )" );
			writer.WriteLine( "option( ICED_X86_NO_D3NOW \"Disable 3DNow instruction support\" OFF )" );
			writer.WriteLine();
			writer.WriteLine( "# CPU architecture for code generation (not instruction decoding)" );
			writer.WriteLine( "# Options: \"native\", \"avx2\", \"avx\", \"sse4.2\", \"sse2\", or empty for default" );
			writer.WriteLine( "set( ICED_X86_ARCH \"sse4.2\" CACHE STRING \"Target CPU architecture for optimizations (native, avx2, avx, sse4.2, sse2)\" )" );
			writer.WriteLine();
			writer.WriteLine( "# Use constexpr handler tables (eliminates runtime deserialization)" );
			writer.WriteLine( "# Note: constexpr handlers require additional work to fully support all handler types" );
			writer.WriteLine( "option( ICED_X86_CONSTEXPR_HANDLERS \"Use constexpr handler tables instead of runtime deserialization\" OFF )" );
			writer.WriteLine();

			// Feature Validation section
			writer.WriteLine( "# ============================================================================" );
			writer.WriteLine( "# Feature Validation" );
			writer.WriteLine( "# ============================================================================" );
			writer.WriteLine();
			writer.WriteLine( "# Validate feature dependencies" );
			writer.WriteLine( "if( ICED_X86_BLOCK_ENCODER AND NOT ICED_X86_ENCODER )" );
			writer.WriteLine( "  message(FATAL_ERROR \"ICED_X86_BLOCK_ENCODER requires ICED_X86_ENCODER to be enabled\")" );
			writer.WriteLine( "endif()" );
			writer.WriteLine();
			writer.WriteLine( "if( ICED_X86_ENCODER AND NOT ICED_X86_DECODER )" );
			writer.WriteLine( "  message(FATAL_ERROR \"ICED_X86_ENCODER requires ICED_X86_DECODER to be enabled (encoder uses decoder tables)\")" );
			writer.WriteLine( "endif()" );
			writer.WriteLine();

			// Source Files section
			writer.WriteLine( "# ============================================================================" );
			writer.WriteLine( "# Source Files - Conditionally included based on features" );
			writer.WriteLine( "# ============================================================================" );
			writer.WriteLine();
			writer.WriteLine( "# Core sources (always needed)" );
			writer.WriteLine( "set( ICED_X86_CORE_SOURCES" );
			writer.WriteLine( "  src/instruction.cpp" );
			writer.WriteLine( "  src/tables.cpp" );
			writer.WriteLine( "  src/register_info.cpp" );
			writer.WriteLine( "  src/memory_size_info.cpp" );
			writer.WriteLine( "  src/mvex_info_data.cpp" );
			writer.WriteLine( ")" );
			writer.WriteLine();
			writer.WriteLine( "# Decoder sources" );
			writer.WriteLine( "set( ICED_X86_DECODER_SOURCES" );
			writer.WriteLine( "  src/decoder.cpp" );
			writer.WriteLine( "  src/handlers.cpp" );
			writer.WriteLine( ")" );
			writer.WriteLine();
			writer.WriteLine( "# Table deserializer is only needed when not using constexpr handlers" );
			writer.WriteLine( "if( NOT ICED_X86_CONSTEXPR_HANDLERS )" );
			writer.WriteLine( "  list( APPEND ICED_X86_DECODER_SOURCES src/table_deserializer.cpp )" );
			writer.WriteLine( "endif()" );
			writer.WriteLine();
			writer.WriteLine( "# Encoder sources (includes instruction_create for programmatic instruction building)" );
			writer.WriteLine( "set( ICED_X86_ENCODER_SOURCES" );
			writer.WriteLine( "  src/instruction_create.cpp" );
			writer.WriteLine( "  src/encoder.cpp" );
			writer.WriteLine( "  src/encoder_handlers.cpp" );
			writer.WriteLine( "  src/encoder_methods.cpp" );
			writer.WriteLine( "  src/encoder_ops.cpp" );
			writer.WriteLine( ")" );
			writer.WriteLine();
			writer.WriteLine( "# Block encoder sources" );
			writer.WriteLine( "set( ICED_X86_BLOCK_ENCODER_SOURCES" );
			writer.WriteLine( "  src/block_encoder.cpp" );
			writer.WriteLine( ")" );
			writer.WriteLine();
			writer.WriteLine( "# Op code info sources" );
			writer.WriteLine( "set( ICED_X86_OP_CODE_INFO_SOURCES" );
			writer.WriteLine( "  src/op_code_info.cpp" );
			writer.WriteLine( ")" );
			writer.WriteLine();
			writer.WriteLine( "# Instruction info sources" );
			writer.WriteLine( "set( ICED_X86_INSTR_INFO_SOURCES" );
			writer.WriteLine( "  src/instruction_info.cpp" );
			writer.WriteLine( ")" );
			writer.WriteLine();
			writer.WriteLine( "# Build the source list based on enabled features" );
			writer.WriteLine( "set( ICED_X86_SOURCES ${ICED_X86_CORE_SOURCES} )" );
			writer.WriteLine();
			writer.WriteLine( "if( ICED_X86_DECODER )" );
			writer.WriteLine( "  list( APPEND ICED_X86_SOURCES ${ICED_X86_DECODER_SOURCES} )" );
			writer.WriteLine( "endif()" );
			writer.WriteLine();
			writer.WriteLine( "if( ICED_X86_ENCODER )" );
			writer.WriteLine( "  list( APPEND ICED_X86_SOURCES ${ICED_X86_ENCODER_SOURCES} )" );
			writer.WriteLine( "endif()" );
			writer.WriteLine();
			writer.WriteLine( "if( ICED_X86_BLOCK_ENCODER )" );
			writer.WriteLine( "  list( APPEND ICED_X86_SOURCES ${ICED_X86_BLOCK_ENCODER_SOURCES} )" );
			writer.WriteLine( "endif()" );
			writer.WriteLine();
			writer.WriteLine( "if( ICED_X86_OP_CODE_INFO )" );
			writer.WriteLine( "  list( APPEND ICED_X86_SOURCES ${ICED_X86_OP_CODE_INFO_SOURCES} )" );
			writer.WriteLine( "endif()" );
			writer.WriteLine();
			writer.WriteLine( "if( ICED_X86_INSTR_INFO )" );
			writer.WriteLine( "  list( APPEND ICED_X86_SOURCES ${ICED_X86_INSTR_INFO_SOURCES} )" );
			writer.WriteLine( "endif()" );
			writer.WriteLine();

			// Library target
			writer.WriteLine( "# Library target" );
			writer.WriteLine( "add_library( iced_x86 ${ICED_X86_SOURCES} )" );
			writer.WriteLine();
			writer.WriteLine( "target_include_directories( iced_x86" );
			writer.WriteLine( "  PUBLIC" );
			writer.WriteLine( "    $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>" );
			writer.WriteLine( "    $<INSTALL_INTERFACE:include>" );
			writer.WriteLine( ")" );
			writer.WriteLine();
			writer.WriteLine( "target_compile_features( iced_x86 PUBLIC cxx_std_23 )" );
			writer.WriteLine();

			// Compiler options
			writer.WriteLine( "# Enable warnings and aggressive optimizations" );
			writer.WriteLine( "if( MSVC )" );
			writer.WriteLine( "  target_compile_options( iced_x86 PRIVATE /W4 )" );
			writer.WriteLine( "  # Aggressive optimizations for Release builds" );
			writer.WriteLine( "  target_compile_options( iced_x86 PRIVATE" );
			writer.WriteLine( "    $<$<CONFIG:Release>:/O2>" );
			writer.WriteLine( "    $<$<CONFIG:Release>:/Ob3>" );
			writer.WriteLine( "    $<$<CONFIG:Release>:/Oi>" );
			writer.WriteLine( "    $<$<CONFIG:Release>:/Ot>" );
			writer.WriteLine( "    $<$<CONFIG:Release>:/GT>" );
			writer.WriteLine( "    $<$<CONFIG:Release>:/GL>" );
			writer.WriteLine( "    $<$<CONFIG:Release>:/Gy>" );
			writer.WriteLine( "    $<$<CONFIG:Release>:/EHsc>" );
			writer.WriteLine( "  )" );
			writer.WriteLine( "  # Architecture-specific optimizations for MSVC" );
			writer.WriteLine( "  if( ICED_X86_ARCH STREQUAL \"native\" OR ICED_X86_ARCH STREQUAL \"avx2\" )" );
			writer.WriteLine( "    target_compile_options( iced_x86 PRIVATE $<$<CONFIG:Release>:/arch:AVX2> )" );
			writer.WriteLine( "  elseif( ICED_X86_ARCH STREQUAL \"avx\" )" );
			writer.WriteLine( "    target_compile_options( iced_x86 PRIVATE $<$<CONFIG:Release>:/arch:AVX> )" );
			writer.WriteLine( "  elseif( ICED_X86_ARCH STREQUAL \"sse4.2\" OR ICED_X86_ARCH STREQUAL \"sse2\" )" );
			writer.WriteLine( "    # SSE2 is the default for x64, no flag needed (SSE4.2 has no specific MSVC flag)" );
			writer.WriteLine( "  endif()" );
			writer.WriteLine( "  # Link-time code generation for Release" );
			writer.WriteLine( "  set_target_properties( iced_x86 PROPERTIES" );
			writer.WriteLine( "    STATIC_LIBRARY_OPTIONS \"$<$<CONFIG:Release>:/LTCG>\"" );
			writer.WriteLine( "  )" );
			writer.WriteLine( "else()" );
			writer.WriteLine( "  target_compile_options( iced_x86 PRIVATE -Wall -Wextra -Wpedantic )" );
			writer.WriteLine( "  # Aggressive optimizations for Release builds (GCC/Clang)" );
			writer.WriteLine( "  target_compile_options( iced_x86 PRIVATE" );
			writer.WriteLine( "    $<$<CONFIG:Release>:-O3>" );
			writer.WriteLine( "    $<$<CONFIG:Release>:-flto>" );
			writer.WriteLine( "  )" );
			writer.WriteLine( "  # Architecture-specific optimizations for GCC/Clang" );
			writer.WriteLine( "  if( ICED_X86_ARCH STREQUAL \"native\" )" );
			writer.WriteLine( "    target_compile_options( iced_x86 PRIVATE $<$<CONFIG:Release>:-march=native> )" );
			writer.WriteLine( "  elseif( ICED_X86_ARCH STREQUAL \"avx2\" )" );
			writer.WriteLine( "    target_compile_options( iced_x86 PRIVATE $<$<CONFIG:Release>:-march=haswell> )" );
			writer.WriteLine( "  elseif( ICED_X86_ARCH STREQUAL \"avx\" )" );
			writer.WriteLine( "    target_compile_options( iced_x86 PRIVATE $<$<CONFIG:Release>:-march=sandybridge> )" );
			writer.WriteLine( "  elseif( ICED_X86_ARCH STREQUAL \"sse4.2\" )" );
			writer.WriteLine( "    target_compile_options( iced_x86 PRIVATE $<$<CONFIG:Release>:-march=nehalem> )" );
			writer.WriteLine( "  elseif( ICED_X86_ARCH STREQUAL \"sse2\" )" );
			writer.WriteLine( "    target_compile_options( iced_x86 PRIVATE $<$<CONFIG:Release>:-march=x86-64> )" );
			writer.WriteLine( "  endif()" );
			writer.WriteLine( "endif()" );
			writer.WriteLine();

			// Feature-based Preprocessor Definitions
			writer.WriteLine( "# ============================================================================" );
			writer.WriteLine( "# Feature-based Preprocessor Definitions" );
			writer.WriteLine( "# ============================================================================" );
			writer.WriteLine();
			writer.WriteLine( "# Constexpr handlers flag" );
			writer.WriteLine( "if( ICED_X86_CONSTEXPR_HANDLERS )" );
			writer.WriteLine( "  target_compile_definitions( iced_x86 PUBLIC ICED_X86_CONSTEXPR_HANDLERS=1 )" );
			writer.WriteLine( "endif()" );
			writer.WriteLine();
			writer.WriteLine( "# Core feature flags" );
			writer.WriteLine( "if( NOT ICED_X86_DECODER )" );
			writer.WriteLine( "  target_compile_definitions( iced_x86 PUBLIC ICED_X86_NO_DECODER )" );
			writer.WriteLine( "endif()" );
			writer.WriteLine();
			writer.WriteLine( "if( NOT ICED_X86_ENCODER )" );
			writer.WriteLine( "  target_compile_definitions( iced_x86 PUBLIC ICED_X86_NO_ENCODER )" );
			writer.WriteLine( "endif()" );
			writer.WriteLine();
			writer.WriteLine( "if( NOT ICED_X86_BLOCK_ENCODER )" );
			writer.WriteLine( "  target_compile_definitions( iced_x86 PUBLIC ICED_X86_NO_BLOCK_ENCODER )" );
			writer.WriteLine( "endif()" );
			writer.WriteLine();
			writer.WriteLine( "# Information feature flags" );
			writer.WriteLine( "if( NOT ICED_X86_OP_CODE_INFO )" );
			writer.WriteLine( "  target_compile_definitions( iced_x86 PUBLIC ICED_X86_NO_OP_CODE_INFO )" );
			writer.WriteLine( "endif()" );
			writer.WriteLine();
			writer.WriteLine( "if( NOT ICED_X86_INSTR_INFO )" );
			writer.WriteLine( "  target_compile_definitions( iced_x86 PUBLIC ICED_X86_NO_INSTR_INFO )" );
			writer.WriteLine( "endif()" );
			writer.WriteLine();
			writer.WriteLine( "# Formatter feature flags" );
			writer.WriteLine( "if( NOT ICED_X86_GAS )" );
			writer.WriteLine( "  target_compile_definitions( iced_x86 PUBLIC ICED_X86_NO_GAS )" );
			writer.WriteLine( "endif()" );
			writer.WriteLine();
			writer.WriteLine( "if( NOT ICED_X86_INTEL )" );
			writer.WriteLine( "  target_compile_definitions( iced_x86 PUBLIC ICED_X86_NO_INTEL )" );
			writer.WriteLine( "endif()" );
			writer.WriteLine();
			writer.WriteLine( "if( NOT ICED_X86_MASM )" );
			writer.WriteLine( "  target_compile_definitions( iced_x86 PUBLIC ICED_X86_NO_MASM )" );
			writer.WriteLine( "endif()" );
			writer.WriteLine();
			writer.WriteLine( "if( NOT ICED_X86_NASM )" );
			writer.WriteLine( "  target_compile_definitions( iced_x86 PUBLIC ICED_X86_NO_NASM )" );
			writer.WriteLine( "endif()" );
			writer.WriteLine();
			writer.WriteLine( "if( NOT ICED_X86_FAST_FMT )" );
			writer.WriteLine( "  target_compile_definitions( iced_x86 PUBLIC ICED_X86_NO_FAST_FMT )" );
			writer.WriteLine( "endif()" );
			writer.WriteLine();
			writer.WriteLine( "# Instruction set exclusion flags" );
			writer.WriteLine( "if( ICED_X86_NO_VEX )" );
			writer.WriteLine( "  target_compile_definitions( iced_x86 PUBLIC ICED_X86_NO_VEX_INSTRUCTIONS )" );
			writer.WriteLine( "endif()" );
			writer.WriteLine();
			writer.WriteLine( "if( ICED_X86_NO_EVEX )" );
			writer.WriteLine( "  target_compile_definitions( iced_x86 PUBLIC ICED_X86_NO_EVEX_INSTRUCTIONS )" );
			writer.WriteLine( "endif()" );
			writer.WriteLine();
			writer.WriteLine( "if( ICED_X86_NO_XOP )" );
			writer.WriteLine( "  target_compile_definitions( iced_x86 PUBLIC ICED_X86_NO_XOP_INSTRUCTIONS )" );
			writer.WriteLine( "endif()" );
			writer.WriteLine();
			writer.WriteLine( "if( ICED_X86_NO_D3NOW )" );
			writer.WriteLine( "  target_compile_definitions( iced_x86 PUBLIC ICED_X86_NO_D3NOW_INSTRUCTIONS )" );
			writer.WriteLine( "endif()" );
			writer.WriteLine();

			// Installation
			writer.WriteLine( "# Installation" );
			writer.WriteLine( "include( GNUInstallDirs )" );
			writer.WriteLine();
			writer.WriteLine( "install( TARGETS iced_x86" );
			writer.WriteLine( "  EXPORT iced_x86-targets" );
			writer.WriteLine( "  LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}" );
			writer.WriteLine( "  ARCHIVE DESTINATION ${CMAKE_INSTALL_LIBDIR}" );
			writer.WriteLine( ")" );
			writer.WriteLine();
			writer.WriteLine( "install( DIRECTORY include/iced_x86" );
			writer.WriteLine( "  DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}" );
			writer.WriteLine( ")" );
			writer.WriteLine();
			writer.WriteLine( "install( EXPORT iced_x86-targets" );
			writer.WriteLine( "  FILE iced_x86-targets.cmake" );
			writer.WriteLine( "  NAMESPACE iced_x86::" );
			writer.WriteLine( "  DESTINATION ${CMAKE_INSTALL_LIBDIR}/cmake/iced_x86" );
			writer.WriteLine( ")" );
			writer.WriteLine();

			// Feature Summary
			writer.WriteLine( "# ============================================================================" );
			writer.WriteLine( "# Feature Summary" );
			writer.WriteLine( "# ============================================================================" );
			writer.WriteLine();
			writer.WriteLine( "message( STATUS \"iced-x86 C++ library configuration:\" )" );
			writer.WriteLine( "message( STATUS \"  Decoder:       ${ICED_X86_DECODER}\" )" );
			writer.WriteLine( "message( STATUS \"  Encoder:       ${ICED_X86_ENCODER}\" )" );
			writer.WriteLine( "message( STATUS \"  Block Encoder: ${ICED_X86_BLOCK_ENCODER}\" )" );
			writer.WriteLine( "message( STATUS \"  OpCode Info:   ${ICED_X86_OP_CODE_INFO}\" )" );
			writer.WriteLine( "message( STATUS \"  Instr Info:    ${ICED_X86_INSTR_INFO}\" )" );
			writer.WriteLine( "message( STATUS \"  GAS Formatter: ${ICED_X86_GAS}\" )" );
			writer.WriteLine( "message( STATUS \"  Intel Fmt:     ${ICED_X86_INTEL}\" )" );
			writer.WriteLine( "message( STATUS \"  MASM Fmt:      ${ICED_X86_MASM}\" )" );
			writer.WriteLine( "message( STATUS \"  NASM Fmt:      ${ICED_X86_NASM}\" )" );
			writer.WriteLine( "message( STATUS \"  Fast Fmt:      ${ICED_X86_FAST_FMT}\" )" );
			writer.WriteLine( "message( STATUS \"  Target Arch:   ${ICED_X86_ARCH}\" )" );
			writer.WriteLine();

			// Tests
			writer.WriteLine( "# Tests" );
			writer.WriteLine( "option( ICED_X86_BUILD_TESTS \"Build unit tests\" ON )" );
			writer.WriteLine();
			writer.WriteLine( "if( ICED_X86_BUILD_TESTS )" );
			writer.WriteLine( "  enable_testing()" );
			writer.WriteLine( "  add_subdirectory( tests )" );
			writer.WriteLine( "endif()" );
		}

		void GenerateTestsCMakeLists() {
			var filename = CppConstants.GetTestFilename( genTypes, "CMakeLists.txt" );
			var dir = Path.GetDirectoryName( filename );
			if ( !string.IsNullOrEmpty( dir ) && !Directory.Exists( dir ) )
				Directory.CreateDirectory( dir );

			using var writer = new StreamWriter( filename );

			writer.WriteLine( "# SPDX-License-Identifier: MIT" );
			writer.WriteLine( "# Copyright (C) 2018-present iced project and contributors" );
			writer.WriteLine( "#" );
			writer.WriteLine( "# This file was generated by GENERATOR" );
			writer.WriteLine();
			writer.WriteLine( "include( FetchContent )" );
			writer.WriteLine();
			writer.WriteLine( "FetchContent_Declare(" );
			writer.WriteLine( "  Catch2" );
			writer.WriteLine( "  GIT_REPOSITORY https://github.com/catchorg/Catch2.git" );
			writer.WriteLine( "  GIT_TAG v3.4.0" );
			writer.WriteLine( ")" );
			writer.WriteLine( "FetchContent_MakeAvailable( Catch2 )" );
			writer.WriteLine();
			writer.WriteLine( "add_executable( iced_x86_tests" );
			writer.WriteLine( "  test_decoder.cpp" );
			writer.WriteLine( "  test_decoder_manual.cpp" );
			writer.WriteLine( "  test_instruction.cpp" );
			writer.WriteLine( "  test_encoder.cpp" );
			writer.WriteLine( "  test_comprehensive.cpp" );
			writer.WriteLine( ")" );
			writer.WriteLine();
			writer.WriteLine( "target_link_libraries( iced_x86_tests" );
			writer.WriteLine( "  PRIVATE" );
			writer.WriteLine( "    iced_x86" );
			writer.WriteLine( "    Catch2::Catch2WithMain" );
			writer.WriteLine( ")" );
			writer.WriteLine();
			writer.WriteLine( "include( CTest )" );
			writer.WriteLine( "include( Catch )" );
			writer.WriteLine( "catch_discover_tests( iced_x86_tests )" );
		}

		void GenerateMainHeader() {
			var filename = CppConstants.GetHeaderFilename( genTypes, "iced_x86.hpp" );
			var dir = Path.GetDirectoryName( filename );
			if ( !string.IsNullOrEmpty( dir ) && !Directory.Exists( dir ) )
				Directory.CreateDirectory( dir );

			using var writer = new FileWriter( TargetLanguage.Cpp, FileUtils.OpenWrite( filename ) );
			writer.WriteFileHeader();

			var headerGuard = CppConstants.GetHeaderGuard( "ICED_X86" );

			writer.WriteLine( "#pragma once" );
			writer.WriteLine( $"#ifndef {headerGuard}" );
			writer.WriteLine( $"#define {headerGuard}" );
			writer.WriteLine();
			writer.WriteLine( "/// @file" );
			writer.WriteLine( "/// @brief Main include file for iced-x86 C++ library." );
			writer.WriteLine();
			writer.WriteLine( "// Core types" );
			writer.WriteLine( "#include \"iced_x86/code.hpp\"" );
			writer.WriteLine( "#include \"iced_x86/code_size.hpp\"" );
			writer.WriteLine( "#include \"iced_x86/register.hpp\"" );
			writer.WriteLine( "#include \"iced_x86/mnemonic.hpp\"" );
			writer.WriteLine( "#include \"iced_x86/memory_size.hpp\"" );
			writer.WriteLine( "#include \"iced_x86/op_kind.hpp\"" );
			writer.WriteLine( "#include \"iced_x86/rounding_control.hpp\"" );
			writer.WriteLine();
			writer.WriteLine( "// Instruction" );
			writer.WriteLine( "#include \"iced_x86/instruction.hpp\"" );
			writer.WriteLine( "#include \"iced_x86/memory_operand.hpp\"" );
			writer.WriteLine();
			writer.WriteLine( "// Decoder" );
			writer.WriteLine( "#include \"iced_x86/decoder_error.hpp\"" );
			writer.WriteLine( "#include \"iced_x86/decoder_options.hpp\"" );
			writer.WriteLine( "#include \"iced_x86/decoder.hpp\"" );
			writer.WriteLine();
			writer.WriteLine( "// Encoder" );
			writer.WriteLine( "#ifndef ICED_X86_NO_ENCODER" );
			writer.WriteLine( "#include \"iced_x86/instruction_create.hpp\"" );
			writer.WriteLine( "#include \"iced_x86/encoder.hpp\"" );
			writer.WriteLine( "#endif" );
			writer.WriteLine();
			writer.WriteLine( "// Formatter" );
			writer.WriteLine( "#include \"iced_x86/formatter_text_kind.hpp\"" );
			writer.WriteLine( "#include \"iced_x86/formatter_options.hpp\"" );
			writer.WriteLine( "#include \"iced_x86/formatter_output.hpp\"" );
			writer.WriteLine( "#include \"iced_x86/intel_formatter.hpp\"" );
			writer.WriteLine( "#include \"iced_x86/masm_formatter.hpp\"" );
			writer.WriteLine( "#include \"iced_x86/nasm_formatter.hpp\"" );
			writer.WriteLine( "#include \"iced_x86/gas_formatter.hpp\"" );
			writer.WriteLine( "#include \"iced_x86/fast_formatter.hpp\"" );
			writer.WriteLine();
			writer.WriteLine( "// Additional types" );
			writer.WriteLine( "#include \"iced_x86/encoding_kind.hpp\"" );
			writer.WriteLine( "#include \"iced_x86/flow_control.hpp\"" );
			writer.WriteLine( "#include \"iced_x86/cpuid_feature.hpp\"" );
			writer.WriteLine( "#include \"iced_x86/condition_code.hpp\"" );
			writer.WriteLine();
			writer.WriteLine( "// Constants" );
			writer.WriteLine( "#include \"iced_x86/iced_constants.hpp\"" );
			writer.WriteLine();
			writer.WriteLine( "// Register info" );
			writer.WriteLine( "#include \"iced_x86/register_info.hpp\"" );
			writer.WriteLine();
			writer.WriteLine( "// OpCode info" );
			writer.WriteLine( "#include \"iced_x86/op_code_info.hpp\"" );
			writer.WriteLine();
			writer.WriteLine( $"#endif // {headerGuard}" );
		}
	}
}
