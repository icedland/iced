// SPDX-License-Identifier: MIT
// Copyright (C) 2018-present iced project and contributors

using System.IO;
using Generator.IO;

namespace Generator.Decoder.Cpp {
	[Generator( TargetLanguage.Cpp, 99 )]
	sealed class CppCMakeGenerator {
		readonly GenTypes genTypes;

		public CppCMakeGenerator( GeneratorContext generatorContext ) {
			genTypes = generatorContext.Types;
		}

		public void Generate() {
			GenerateCMakeLists();
			GenerateMainHeader();
			GenerateTestsCMakeLists();
		}

		void GenerateCMakeLists() {
			var filename = CppConstants.GetFilename( genTypes, "CMakeLists.txt" );
			var dir = Path.GetDirectoryName( filename );
			if ( !string.IsNullOrEmpty( dir ) && !Directory.Exists( dir ) )
				Directory.CreateDirectory( dir );

			using var writer = new StreamWriter( filename );

			writer.WriteLine( "# SPDX-License-Identifier: MIT" );
			writer.WriteLine( "# Copyright (C) 2018-present iced project and contributors" );
			writer.WriteLine( "#" );
			writer.WriteLine( "# This file was generated by GENERATOR" );
			writer.WriteLine();
			writer.WriteLine( "cmake_minimum_required( VERSION 3.25 )" );
			writer.WriteLine();
			writer.WriteLine( "project( iced_x86" );
			writer.WriteLine( "  VERSION 1.0.0" );
			writer.WriteLine( "  LANGUAGES CXX" );
			writer.WriteLine( "  DESCRIPTION \"x86/x64 disassembler library\"" );
			writer.WriteLine( ")" );
			writer.WriteLine();
			writer.WriteLine( "set( CMAKE_CXX_STANDARD 23 )" );
			writer.WriteLine( "set( CMAKE_CXX_STANDARD_REQUIRED ON )" );
			writer.WriteLine( "set( CMAKE_CXX_EXTENSIONS OFF )" );
			writer.WriteLine();
			writer.WriteLine( "# Library target" );
			writer.WriteLine( "add_library( iced_x86" );
			writer.WriteLine( "  src/instruction.cpp" );
			writer.WriteLine( "  src/instruction_create.cpp" );
			writer.WriteLine( "  src/tables.cpp" );
			writer.WriteLine( "  src/decoder.cpp" );
			writer.WriteLine( "  src/handlers.cpp" );
			writer.WriteLine( "  src/table_deserializer.cpp" );
			writer.WriteLine( "  src/encoder.cpp" );
			writer.WriteLine( "  src/encoder_handlers.cpp" );
			writer.WriteLine( "  src/encoder_methods.cpp" );
			writer.WriteLine( "  src/encoder_ops.cpp" );
			writer.WriteLine( "  src/mvex_info_data.cpp" );
			writer.WriteLine( "  src/register_info.cpp" );
			writer.WriteLine( "  src/op_code_info.cpp" );
			writer.WriteLine( "  src/block_encoder.cpp" );
			writer.WriteLine( "  src/instruction_info.cpp" );
			writer.WriteLine( "  src/memory_size_info.cpp" );
			writer.WriteLine( ")" );
			writer.WriteLine();
			writer.WriteLine( "target_include_directories( iced_x86" );
			writer.WriteLine( "  PUBLIC" );
			writer.WriteLine( "    $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>" );
			writer.WriteLine( "    $<INSTALL_INTERFACE:include>" );
			writer.WriteLine( ")" );
			writer.WriteLine();
			writer.WriteLine( "target_compile_features( iced_x86 PUBLIC cxx_std_23 )" );
			writer.WriteLine();
			writer.WriteLine( "# Enable warnings" );
			writer.WriteLine( "if( MSVC )" );
			writer.WriteLine( "  target_compile_options( iced_x86 PRIVATE /W4 )" );
			writer.WriteLine( "else()" );
			writer.WriteLine( "  target_compile_options( iced_x86 PRIVATE -Wall -Wextra -Wpedantic )" );
			writer.WriteLine( "endif()" );
			writer.WriteLine();
			writer.WriteLine( "# Installation" );
			writer.WriteLine( "include( GNUInstallDirs )" );
			writer.WriteLine();
			writer.WriteLine( "install( TARGETS iced_x86" );
			writer.WriteLine( "  EXPORT iced_x86-targets" );
			writer.WriteLine( "  LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}" );
			writer.WriteLine( "  ARCHIVE DESTINATION ${CMAKE_INSTALL_LIBDIR}" );
			writer.WriteLine( ")" );
			writer.WriteLine();
			writer.WriteLine( "install( DIRECTORY include/iced_x86" );
			writer.WriteLine( "  DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}" );
			writer.WriteLine( ")" );
			writer.WriteLine();
			writer.WriteLine( "install( EXPORT iced_x86-targets" );
			writer.WriteLine( "  FILE iced_x86-targets.cmake" );
			writer.WriteLine( "  NAMESPACE iced_x86::" );
			writer.WriteLine( "  DESTINATION ${CMAKE_INSTALL_LIBDIR}/cmake/iced_x86" );
			writer.WriteLine( ")" );
			writer.WriteLine();
			writer.WriteLine( "# Tests" );
			writer.WriteLine( "option( ICED_X86_BUILD_TESTS \"Build unit tests\" ON )" );
			writer.WriteLine();
			writer.WriteLine( "if( ICED_X86_BUILD_TESTS )" );
			writer.WriteLine( "  enable_testing()" );
			writer.WriteLine( "  add_subdirectory( tests )" );
			writer.WriteLine( "endif()" );
		}

		void GenerateTestsCMakeLists() {
			var filename = CppConstants.GetTestFilename( genTypes, "CMakeLists.txt" );
			var dir = Path.GetDirectoryName( filename );
			if ( !string.IsNullOrEmpty( dir ) && !Directory.Exists( dir ) )
				Directory.CreateDirectory( dir );

			using var writer = new StreamWriter( filename );

			writer.WriteLine( "# SPDX-License-Identifier: MIT" );
			writer.WriteLine( "# Copyright (C) 2018-present iced project and contributors" );
			writer.WriteLine( "#" );
			writer.WriteLine( "# This file was generated by GENERATOR" );
			writer.WriteLine();
			writer.WriteLine( "include( FetchContent )" );
			writer.WriteLine();
			writer.WriteLine( "FetchContent_Declare(" );
			writer.WriteLine( "  Catch2" );
			writer.WriteLine( "  GIT_REPOSITORY https://github.com/catchorg/Catch2.git" );
			writer.WriteLine( "  GIT_TAG v3.4.0" );
			writer.WriteLine( ")" );
			writer.WriteLine( "FetchContent_MakeAvailable( Catch2 )" );
			writer.WriteLine();
			writer.WriteLine( "add_executable( iced_x86_tests" );
			writer.WriteLine( "  test_decoder.cpp" );
			writer.WriteLine( "  test_decoder_manual.cpp" );
			writer.WriteLine( "  test_instruction.cpp" );
			writer.WriteLine( "  test_encoder.cpp" );
			writer.WriteLine( "  test_comprehensive.cpp" );
			writer.WriteLine( ")" );
			writer.WriteLine();
			writer.WriteLine( "target_link_libraries( iced_x86_tests" );
			writer.WriteLine( "  PRIVATE" );
			writer.WriteLine( "    iced_x86" );
			writer.WriteLine( "    Catch2::Catch2WithMain" );
			writer.WriteLine( ")" );
			writer.WriteLine();
			writer.WriteLine( "include( CTest )" );
			writer.WriteLine( "include( Catch )" );
			writer.WriteLine( "catch_discover_tests( iced_x86_tests )" );
		}

		void GenerateMainHeader() {
			var filename = CppConstants.GetHeaderFilename( genTypes, "iced_x86.hpp" );
			var dir = Path.GetDirectoryName( filename );
			if ( !string.IsNullOrEmpty( dir ) && !Directory.Exists( dir ) )
				Directory.CreateDirectory( dir );

			using var writer = new FileWriter( TargetLanguage.Cpp, FileUtils.OpenWrite( filename ) );
			writer.WriteFileHeader();

			var headerGuard = CppConstants.GetHeaderGuard( "ICED_X86" );

			writer.WriteLine( "#pragma once" );
			writer.WriteLine( $"#ifndef {headerGuard}" );
			writer.WriteLine( $"#define {headerGuard}" );
			writer.WriteLine();
			writer.WriteLine( "/// @file" );
			writer.WriteLine( "/// @brief Main include file for iced-x86 C++ library." );
			writer.WriteLine();
			writer.WriteLine( "// Core types" );
			writer.WriteLine( "#include \"iced_x86/code.hpp\"" );
			writer.WriteLine( "#include \"iced_x86/code_size.hpp\"" );
			writer.WriteLine( "#include \"iced_x86/register.hpp\"" );
			writer.WriteLine( "#include \"iced_x86/mnemonic.hpp\"" );
			writer.WriteLine( "#include \"iced_x86/memory_size.hpp\"" );
			writer.WriteLine( "#include \"iced_x86/op_kind.hpp\"" );
			writer.WriteLine( "#include \"iced_x86/rounding_control.hpp\"" );
			writer.WriteLine();
			writer.WriteLine( "// Instruction" );
			writer.WriteLine( "#include \"iced_x86/instruction.hpp\"" );
			writer.WriteLine( "#include \"iced_x86/instruction_create.hpp\"" );
			writer.WriteLine( "#include \"iced_x86/memory_operand.hpp\"" );
			writer.WriteLine();
			writer.WriteLine( "// Decoder" );
			writer.WriteLine( "#include \"iced_x86/decoder_error.hpp\"" );
			writer.WriteLine( "#include \"iced_x86/decoder_options.hpp\"" );
			writer.WriteLine( "#include \"iced_x86/decoder.hpp\"" );
			writer.WriteLine();
			writer.WriteLine( "// Encoder" );
			writer.WriteLine( "#include \"iced_x86/encoder.hpp\"" );
			writer.WriteLine();
			writer.WriteLine( "// Formatter" );
			writer.WriteLine( "#include \"iced_x86/formatter_text_kind.hpp\"" );
			writer.WriteLine( "#include \"iced_x86/formatter_options.hpp\"" );
			writer.WriteLine( "#include \"iced_x86/formatter_output.hpp\"" );
			writer.WriteLine( "#include \"iced_x86/intel_formatter.hpp\"" );
			writer.WriteLine( "#include \"iced_x86/masm_formatter.hpp\"" );
			writer.WriteLine( "#include \"iced_x86/nasm_formatter.hpp\"" );
			writer.WriteLine( "#include \"iced_x86/gas_formatter.hpp\"" );
			writer.WriteLine( "#include \"iced_x86/fast_formatter.hpp\"" );
			writer.WriteLine();
			writer.WriteLine( "// Additional types" );
			writer.WriteLine( "#include \"iced_x86/encoding_kind.hpp\"" );
			writer.WriteLine( "#include \"iced_x86/flow_control.hpp\"" );
			writer.WriteLine( "#include \"iced_x86/cpuid_feature.hpp\"" );
			writer.WriteLine( "#include \"iced_x86/condition_code.hpp\"" );
			writer.WriteLine();
			writer.WriteLine( "// Constants" );
			writer.WriteLine( "#include \"iced_x86/iced_constants.hpp\"" );
			writer.WriteLine();
			writer.WriteLine( "// Register info" );
			writer.WriteLine( "#include \"iced_x86/register_info.hpp\"" );
			writer.WriteLine();
			writer.WriteLine( "// OpCode info" );
			writer.WriteLine( "#include \"iced_x86/op_code_info.hpp\"" );
			writer.WriteLine();
			writer.WriteLine( $"#endif // {headerGuard}" );
		}
	}
}
